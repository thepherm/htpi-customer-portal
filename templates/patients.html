{% extends "layout.html" %}

{% block title %}Patients - HTPI Customer Portal{% endblock %}

{% block page_content %}
<div class="sm:flex sm:items-center">
    <div class="sm:flex-auto">
        <h1 class="text-xl font-semibold text-gray-900">Patients</h1>
        <p class="mt-2 text-sm text-gray-700">A list of all patients in your organization.</p>
    </div>
    <div class="mt-4 sm:mt-0 sm:ml-16 sm:flex-none">
        <button onclick="showAddPatientModal()" class="inline-flex items-center justify-center rounded-md border border-transparent bg-indigo-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-indigo-700">
            <i class="fas fa-plus mr-2"></i>Add Patient
        </button>
    </div>
</div>

<!-- Search Bar -->
<div class="mt-6">
    <div class="relative">
        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
            <i class="fas fa-search text-gray-400"></i>
        </div>
        <input type="text" id="patientSearch" class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md leading-5 bg-white placeholder-gray-500 focus:outline-none focus:placeholder-gray-400 focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Search patients...">
    </div>
</div>

<!-- Patients Table -->
<div class="mt-8 flex flex-col">
    <div class="-my-2 -mx-4 overflow-x-auto sm:-mx-6 lg:-mx-8">
        <div class="inline-block min-w-full py-2 align-middle md:px-6 lg:px-8">
            <div class="overflow-hidden shadow ring-1 ring-black ring-opacity-5 md:rounded-lg">
                <table class="min-w-full divide-y divide-gray-300">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="py-3.5 pl-4 pr-3 text-left text-sm font-semibold text-gray-900 sm:pl-6">Name</th>
                            <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Email</th>
                            <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Phone</th>
                            <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Status</th>
                            <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Last Visit</th>
                            <th scope="col" class="relative py-3.5 pl-3 pr-4 sm:pr-6">
                                <span class="sr-only">Actions</span>
                            </th>
                        </tr>
                    </thead>
                    <tbody id="patientsTableBody" class="divide-y divide-gray-200 bg-white">
                        <tr>
                            <td colspan="6" class="text-center py-4">
                                <i class="fas fa-circle-notch fa-spin text-gray-400 mr-2"></i>
                                Connecting to patient data stream...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Add Patient Modal -->
<div id="addPatientModal" class="hidden fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg px-4 pt-5 pb-4 text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:max-w-lg sm:w-full sm:p-6">
        <div class="absolute top-0 right-0 pt-4 pr-4">
            <button onclick="closeAddPatientModal()" class="bg-white rounded-md text-gray-400 hover:text-gray-500">
                <span class="sr-only">Close</span>
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div>
            <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Add New Patient</h3>
            <form id="addPatientForm">
                <div class="space-y-4">
                    <div>
                        <label for="firstName" class="block text-sm font-medium text-gray-700">First Name</label>
                        <input type="text" name="firstName" id="firstName" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="lastName" class="block text-sm font-medium text-gray-700">Last Name</label>
                        <input type="text" name="lastName" id="lastName" required class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
                        <input type="email" name="email" id="email" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="phone" class="block text-sm font-medium text-gray-700">Phone</label>
                        <input type="tel" name="phone" id="phone" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                </div>
                <div class="mt-5 sm:mt-6 sm:grid sm:grid-cols-2 sm:gap-3 sm:grid-flow-row-dense">
                    <button type="submit" id="addPatientBtn" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-indigo-600 text-base font-medium text-white hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:col-start-2 sm:text-sm">
                        Add Patient
                    </button>
                    <button type="button" onclick="closeAddPatientModal()" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:col-start-1 sm:text-sm">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Initialize Socket.IO with auth token
    const socket = initSocket('{{ session_token }}');
    let allPatients = [];
    let searchTerm = '';
    
    // Subscribe to patient data when connected
    socket.on('connect', () => {
        console.log('Patients page connected to gateway');
        
        // Subscribe to patient updates
        socket.emit('patients:subscribe', {
            organizationId: '{{ user.organizationId }}'
        });
    });
    
    // Listen for patient list updates
    socket.on('patients:list', (patients) => {
        allPatients = patients || [];
        renderPatients(filterPatients());
    });
    
    // Listen for individual patient updates
    socket.on('patients:update', (patient) => {
        const index = allPatients.findIndex(p => p.id === patient.id);
        if (index >= 0) {
            allPatients[index] = patient;
        } else {
            allPatients.unshift(patient);
        }
        renderPatients(filterPatients());
    });
    
    // Listen for patient deletion
    socket.on('patients:delete', (patientId) => {
        allPatients = allPatients.filter(p => p.id !== patientId);
        renderPatients(filterPatients());
    });
    
    // Listen for real-time patient additions
    socket.on('patients:new', (patient) => {
        allPatients.unshift(patient);
        renderPatients(filterPatients());
        
        // Highlight new patient
        setTimeout(() => {
            const row = document.querySelector(`tr[data-patient-id="${patient.id}"]`);
            if (row) {
                row.classList.add('bg-green-50');
                setTimeout(() => row.classList.remove('bg-green-50'), 2000);
            }
        }, 100);
    });
    
    function filterPatients() {
        if (!searchTerm) return allPatients;
        
        const term = searchTerm.toLowerCase();
        return allPatients.filter(patient => 
            patient.firstName.toLowerCase().includes(term) ||
            patient.lastName.toLowerCase().includes(term) ||
            (patient.email && patient.email.toLowerCase().includes(term)) ||
            (patient.phone && patient.phone.includes(term))
        );
    }
    
    function renderPatients(patients) {
        const tbody = document.getElementById('patientsTableBody');
        
        if (!socket.connected) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center py-4 text-red-600">
                        <i class="fas fa-exclamation-circle mr-2"></i>
                        Disconnected from server. Attempting to reconnect...
                    </td>
                </tr>
            `;
            return;
        }
        
        if (patients.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center py-4 text-gray-500">
                        ${searchTerm ? 'No patients found matching your search' : 'No patients found'}
                    </td>
                </tr>
            `;
            return;
        }
        
        tbody.innerHTML = patients.map(patient => `
            <tr data-patient-id="${patient.id}" class="transition-colors duration-500">
                <td class="whitespace-nowrap py-4 pl-4 pr-3 text-sm sm:pl-6">
                    <div class="flex items-center">
                        <div class="h-10 w-10 flex-shrink-0">
                            <div class="h-10 w-10 rounded-full bg-indigo-100 flex items-center justify-center">
                                <span class="text-indigo-600 font-medium">${patient.firstName[0]}${patient.lastName[0]}</span>
                            </div>
                        </div>
                        <div class="ml-4">
                            <div class="font-medium text-gray-900">${patient.firstName} ${patient.lastName}</div>
                            <div class="text-gray-500">ID: ${patient.id}</div>
                        </div>
                    </div>
                </td>
                <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">${patient.email || '-'}</td>
                <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">${patient.phone || '-'}</td>
                <td class="whitespace-nowrap px-3 py-4 text-sm">
                    <span class="inline-flex rounded-full px-2 text-xs font-semibold leading-5 ${getStatusClass(patient.status)}">
                        ${patient.status || 'Active'}
                    </span>
                </td>
                <td class="whitespace-nowrap px-3 py-4 text-sm text-gray-500">
                    ${patient.lastVisit ? formatDate(patient.lastVisit) : '-'}
                </td>
                <td class="relative whitespace-nowrap py-4 pl-3 pr-4 text-right text-sm font-medium sm:pr-6">
                    <a href="#" onclick="viewPatient('${patient.id}')" class="text-indigo-600 hover:text-indigo-900">View</a>
                </td>
            </tr>
        `).join('');
    }
    
    function getStatusClass(status) {
        const classes = {
            'Active': 'bg-green-100 text-green-800',
            'Inactive': 'bg-red-100 text-red-800',
            'Pending': 'bg-yellow-100 text-yellow-800'
        };
        return classes[status] || 'bg-gray-100 text-gray-800';
    }
    
    function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString();
    }
    
    // Search functionality
    document.getElementById('patientSearch').addEventListener('input', (e) => {
        searchTerm = e.target.value;
        renderPatients(filterPatients());
    });
    
    // Modal functions
    function showAddPatientModal() {
        document.getElementById('addPatientModal').classList.remove('hidden');
    }
    
    function closeAddPatientModal() {
        document.getElementById('addPatientModal').classList.add('hidden');
        document.getElementById('addPatientForm').reset();
    }
    
    // Add patient form
    document.getElementById('addPatientForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const patientData = Object.fromEntries(formData);
        const addBtn = document.getElementById('addPatientBtn');
        
        // Show loading state
        addBtn.disabled = true;
        addBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Adding...';
        
        // Emit add patient event
        socket.emit('patients:add', {
            ...patientData,
            organizationId: '{{ user.organizationId }}'
        });
        
        // Listen for response
        socket.once('patients:add:response', (response) => {
            if (response.success) {
                closeAddPatientModal();
            } else {
                alert(response.error || 'Failed to add patient');
            }
            
            // Reset button
            addBtn.disabled = false;
            addBtn.innerHTML = 'Add Patient';
        });
    });
    
    function viewPatient(patientId) {
        // Emit event to request patient details
        socket.emit('patients:details', { patientId });
        
        // In a real app, this would navigate to a patient detail page
        console.log('View patient:', patientId);
    }
    
    // Handle disconnection
    socket.on('disconnect', () => {
        console.log('Patients page disconnected from gateway');
        renderPatients(allPatients);
    });
    
    // Handle reconnection
    socket.on('reconnect', () => {
        console.log('Patients page reconnected to gateway');
        // Re-subscribe to patient data
        socket.emit('patients:subscribe', {
            organizationId: '{{ user.organizationId }}'
        });
    });
</script>
{% endblock %}